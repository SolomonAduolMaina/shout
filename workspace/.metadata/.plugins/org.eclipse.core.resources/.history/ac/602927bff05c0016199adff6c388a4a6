<?php
error_reporting ( E_ALL );
ini_set ( 'display_errors', 1 );

$host_name = 'localhost';
$user_name = '987829';
$password = 'Auremest7';

$data = file_get_contents ( 'php://input' );
$json = json_decode ( $data, true );
$user_id = $json ['user_id'];
$search_query = $json ['search_query'];
$offset = $json ['offset'];

$connection = mysqli_connect ( $host_name, $user_name, $password, $user_name );
$events_query = "SELECT Event.*, 
((Event.creator_id = $user_id) OR (Invite.invitee_id = $user_id)) AS is_user 
FROM Event LEFT OUTER JOIN Invite ON Event.event_id = Invite.event_id
WHERE INSTR(title, $search_query) > 0 ORDER BY going DESC 
LIMIT 10 OFFSET $offset";

$friends_query = "SELECT User.*, Connection.friend_id = $user_id AS is_friend
FROM User LEFT JOIN Connection ON User.user_id = Connection.user_id
WHERE INSTR(User.user_name, $search_query) > 0 ORDER BY is_friend DESC
LIMIT 10 OFFSET $offset";

$groups_query = "SELECT ShoutGroup.* FROM ShoutGroup LEFT OUTER JOIN GroupMember 
ON ShoutGroup.group_id = GroupMember.group_id 
WHERE INSTR(ShoutGroup.group_name, $search_query) > 0 AND
(GroupMember.user_id = $user_id OR ShoutGroup.type = 'Public')
ORDER BY GroupMember.user_id DESC LIMIT 10 OFFSET $offset";

$events_result = mysqli_query ( $connection, $events_query );
$events = array ();
while ( $row = mysqli_fetch_assoc ( $events_result ) ) {
	array_push ( $events, $row );
}

$friends_result = mysqli_query ( $connection, $friends_query );
$friends = array ();
while ( $row = mysqli_fetch_assoc ( $friends_result ) ) {
	array_push ( $friends, $row );
}

$groups_result = mysqli_query ( $connection, $groups_query );
$groups = array ();
while ( $row = mysqli_fetch_assoc ( $groups_result ) ) {
	array_push ( $groups, $row );
}

if ($events_result != FALSE && $friends_result != FALSE && $groups_result != FALSE) {
	echo json_encode ( array (
			'search_results' => "Success!",
			'events' => $events,
			'friends' => $friends,
			'groups' => $groups,
			'error_message' => "" 
	) );
} else {
	echo json_encode ( array (
			'search_results' => "Failure!",
			'events' => "",
			'friends' => "",
			'groups' => "",
			'error_message' => mysqli_error ( $connection ) 
	) );
}
?>